datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  currency  String   @default("USD")
  locale    String   @default("en-US")
  logoUrl   String?
  brandColor String?
  onboardingCompleted Boolean @default(false)
  stores    Store[]
  users     User[]
  products  Product[]
  sales     Sale[]
  returns   SalesReturn[]
  customers Customer[]
  suppliers Supplier[]
  taxes     Tax[]
  discounts Discount[]
  roles     Role[]
  tills     Till[]
  purchaseOrders PurchaseOrder[]
  productCategories ProductCategory[]
  
  // Loyalty Settings
  loyaltyEarnRate   Decimal  @default(1.0)  // Points per Currency Unit
  loyaltyRedeemRate Decimal  @default(0.10) // Value per Point
  loyaltyExpiryDays Int      @default(365)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Store {
  id        String   @id @default(uuid())
  name      String
  address   String?
  phone     String?
  email     String?
  website   String?
  logoUrl   String?
  receiptHeader String?
  receiptFooter String?
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  users     User[]
  inventory Inventory[]
  sales     Sale[]
  returns   SalesReturn[]
  tills     Till[]
  products  Product[]
  customers Customer[]
  suppliers Supplier[]
  inventoryEvents InventoryEvent[]
  purchaseOrders PurchaseOrder[]
  grns          GoodsReceivedNote[]
  supplierReturns SupplierReturn[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String   // Hashed
  
  // RBAC Relations
  roleId    String?
  roleDef   Role?    @relation(fields: [roleId], references: [id])



  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id])
  inventoryEvents InventoryEvent[]
  sales     Sale[]
  returnsProcessed SalesReturn[]
  tillSessions TillSession[]
  purchaseOrdersCreated PurchaseOrder[]
  grnsReceived GoodsReceivedNote[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  permissions String[] @default([]) // List of permission strings e.g. "MANAGE_PRODUCTS"
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  users       User[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
}

model Product {
  id          String   @id @default(uuid())
  sku         String
  barcode     String?
  name        String
  // New Relation
  categoryId  String?
  category    ProductCategory? @relation(fields: [categoryId], references: [id])
  
  description String?
  price       Decimal  // Selling Price
  costPrice   Decimal  @default(0.0) // Purchase Price
  minStockLevel Int    @default(0)
  taxRate     Decimal  @default(0.0)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  
  // Store Isolation
  storeId     String?
  store       Store?    @relation(fields: [storeId], references: [id])

  inventory   Inventory[]
  saleItems   SaleItem[]
  returnItems SalesReturnItem[]
  inventoryEvents InventoryEvent[]
  supplierProducts SupplierProduct[]
  poItems       PurchaseOrderItem[]
  grnItems      GRNItem[]
  supplierReturnItems   SupplierReturnItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sku, tenantId])
  @@unique([barcode, tenantId])
}

model ProductCategory {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([name, tenantId])
}

model Inventory {
  id        String   @id @default(uuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(0)
  updatedAt DateTime @updatedAt

  @@unique([storeId, productId])
}

model InventoryEvent {
  id        String   @id @default(uuid())
  type      String   // RECEIVE, SALE, ADJUSTMENT, TRANSFER, RETURN
  quantity  Int      // Positive or negative change
  reason    String?
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  supplierId String?
  supplier  Supplier? @relation(fields: [supplierId], references: [id])
  createdAt DateTime @default(now())
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  phone     String?
  email     String?
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id])
  
  isSystem  Boolean  @default(false)
  
  currency  String   @default("USD")
  termDays  Int      @default(30)

  events    InventoryEvent[]
  products  Product[]         // Legacy Relation
  supplierProducts SupplierProduct[] // New Multi-Supplier Relation
  purchaseOrders PurchaseOrder[]
  returns   SupplierReturn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tax {
  id        String   @id @default(uuid())
  name      String
  rate      Decimal  // Percentage (e.g. 0.05)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Discount {
  id           String   @id @default(uuid())
  name         String
  type         String   // PERCENTAGE, FIXED
  value        Decimal
  targetType   String   @default("ALL") // ALL, PRODUCT, CATEGORY
  targetValues String[] // List of IDs or Category Names
  startDate    DateTime? // Optional Start Date
  endDate      DateTime? // Optional End Date
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Sale {
  id            String     @id @default(uuid())
  total         Decimal
  subtotal      Decimal    @default(0.0)

  taxTotal      Decimal    @default(0.0)
  discountTotal Decimal    @default(0.0)
  paymentMethod String     @default("CASH") // Primary/Summary method
  payments      SalePayment[]
  status        String     @default("COMPLETED")
  
  tenantId      String
  tenant        Tenant     @relation(fields: [tenantId], references: [id])
  
  storeId       String
  store         Store      @relation(fields: [storeId], references: [id])
  
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  
  tillSessionId String?
  tillSession   TillSession? @relation(fields: [tillSessionId], references: [id])

  customerId    String?
  customer      Customer?  @relation(fields: [customerId], references: [id])
  
  loyaltyPointsUsed   Int @default(0)
  loyaltyPointsEarned Int @default(0)
  loyaltyDiscountAmount Decimal @default(0)

  items         SaleItem[]
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  returns       SalesReturn[]
}

model SalePayment {
  id        String   @id @default(uuid())
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id])
  method    String   // CASH, CARD, TRANSFER
  amount    Decimal
  reference String?  // Transaction ID
  createdAt DateTime @default(now())
}

model Customer {
  id        String   @id @default(uuid())
  code      String   @unique // Human readable e.g. C-1025
  name      String
  email     String?
  phone     String?
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  // Store Isolation
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id])
  
  loyaltyPoints Int      @default(0)
  isLoyaltyMember Boolean @default(false)
  
  sales     Sale[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SaleItem {
  id          String   @id @default(uuid())
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  priceAtSale Decimal
  costAtSale  Decimal  @default(0.0)
  
  createdAt   DateTime @default(now())
}


model Till {
  id        String   @id @default(uuid())
  name      String
  status    String   @default("CLOSED") // OPEN, CLOSED
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  sessions  TillSession[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TillSession {
  id           String   @id @default(uuid())
  tillId       String
  till         Till     @relation(fields: [tillId], references: [id])
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  openedAt     DateTime @default(now())
  closedAt     DateTime?
  openingFloat Decimal  @default(0.0)
  closingCash  Decimal?
  expectedCash Decimal?
  variance     Decimal?
  status       String   @default("OPEN") // OPEN, CLOSED
  
  sales        Sale[]
  cashTransactions CashTransaction[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model CashTransaction {
  id            String   @id @default(uuid())
  tillSessionId String
  tillSession   TillSession @relation(fields: [tillSessionId], references: [id])
  type          String   // CASH_IN, CASH_OUT
  amount        Decimal
  reason        String?
  description   String?
  createdAt     DateTime @default(now())
}

model SalesReturn {
  id          String   @id @default(uuid())
  
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  
  total       Decimal
  reason      String?
  
  items       SalesReturnItem[]
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  
  createdBy   String
  user        User     @relation(fields: [createdBy], references: [id])
  
  createdAt   DateTime @default(now())
}

model SalesReturnItem {
  id          String   @id @default(uuid())
  
  returnId    String
  return      SalesReturn   @relation(fields: [returnId], references: [id])
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  restock     Boolean  @default(true)
  refundAmount Decimal
}

model SupplierProduct {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  supplierSku String?
  lastCost    Decimal  @default(0.0)
  isPreferred Boolean  @default(false)

  @@unique([supplierId, productId])
}

model PurchaseOrder {
  id            String   @id @default(uuid())
  poNumber      String   // Scoped unique constraint below
  status        String   @default("DRAFT") // DRAFT, SENT, PARTIALLY_RECEIVED, FULLY_RECEIVED, CLOSED, CANCELLED
  
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  createdBy     String
  user          User     @relation(fields: [createdBy], references: [id])
  
  totalAmount   Decimal  @default(0.0)
  notes         String?
  
  items         PurchaseOrderItem[]
  grns          GoodsReceivedNote[]
  invoices      SupplierInvoice[]
  returns       SupplierReturn[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([poNumber, tenantId])
}

model PurchaseOrderItem {
  id            String   @id @default(uuid())
  poId          String
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  
  productId     String
  product       Product   @relation(fields: [productId], references: [id])
  
  quantityOrdered Int
  quantityReceived Int      @default(0)
  
  unitCost      Decimal
  totalCost     Decimal
}

model GoodsReceivedNote {
  id            String   @id @default(uuid())
  grnNumber     String   @unique
  
  poId          String
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  
  receivedBy    String
  user          User     @relation(fields: [receivedBy], references: [id])
  
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  
  receivedDate  DateTime @default(now())
  notes         String?
  
  items         GRNItem[]
  
  invoiceId     String?
}

model GRNItem {
  id            String   @id @default(uuid())
  grnId         String
  grn           GoodsReceivedNote @relation(fields: [grnId], references: [id])
  
  productId     String
  product       Product @relation(fields: [productId], references: [id])
  
  quantityReceived Int
  
  batchNumber   String?
  expiryDate    DateTime?
}

model SupplierInvoice {
  id            String   @id @default(uuid())
  invoiceNumber String
  
  poId          String
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  
  amount        Decimal
  status        String   @default("PENDING") // PENDING, PAID, DISPUTED
  
  dueDate       DateTime?
  createdAt     DateTime @default(now())
}

model SupplierReturn {
  id            String   @id @default(uuid())
  returnNumber  String   @unique
  
  poId          String?  // Optional link
  purchaseOrder PurchaseOrder? @relation(fields: [poId], references: [id])
  
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  
  status        String   @default("PENDING")
  reason        String?
  
  items         SupplierReturnItem[]
  
  createdAt     DateTime @default(now())
}

model SupplierReturnItem {
  id            String   @id @default(uuid())
  returnId      String
  supplierReturn SupplierReturn @relation(fields: [returnId], references: [id])
  
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  
  quantity      Int
  batchNumber   String?
}
